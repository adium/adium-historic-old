<?xml version="1.0"?>
<?xml-stylesheet href="transform.xsl" type="text/xsl"?>
<page>
  <title>Adium SQL Logger Technical Details</title>
  <body>
    <p>This page describes a few more technical details of the Adium SQL Logging
    Plugin.</p>
    <div align="center">
      <a href="#im.sql">im.sql</a> | 
      <a href="#tsearch.sql">tsearch.sql</a> | 
      <a href="#parser.pl">parser.pl/parser-2.pl</a>
    </div>

    <a name="im.sql"><h2>im.sql</h2></a>
    <p>The file <code>im.sql</code> contains instructions for setting up a
    database schema for use with Adium's SQL Logging. 
    Running the file creates the adium schema, two tables and one
    view.</p>
    <h3>users</h3>
    <p>The first table that is created is <code>users</code>.  It is very
    simple, storing only a username, a service, and a code, user_id.  Everyone
    who sends or receives a message will have an entry in
    <code>users</code>.</p>
    <h3>messages</h3>
    <p>The second table, messages, contains the basis for the plugin: the
    messages.  Named <code>messages</code>, it has a sequenced field for each
    message (message_id), the message itself (message), the message date and
    time (message_date), and two references to users (sender_id,
    recipient_id).  If you have tsearch indexing setup, it contains another
    field (message_idx).</p>
    <h3>user_display_name</h3>
    <p>The user_display_name table is quite simple.  It has a user_id field,
      which references <code>users.user_id</code>, a text field (display_name)
      and a date (effdate).  This table is used for storing Aliases and
      Display Names.  It stores them by date to get the most clear picture of
      someone whose display name/alias changes often.</p>
    <p>Adium makes no distinction between an alias that you set, and a
      server-side display name.  So it will record either their server-side
      name, or your alias for them.</p>
    <p>As an example, let's say I'm talking to my friend Colin (user_id 100) on MSN.
      He has recently changed his MSN name to <i>Colin Rocks!  He's so cool!  
        He's so good at everything!</i>
      When he IMs me at 6:15, a row is inserted into user_display_name with
      his name and the date (6:15).  We talk for a bit.
      Since this name is annoying, I set his alias to <i>Colin</i> at 6:30.
      Nothing changes in the database, since I haven't IMed him yet.
      At 6:45, I IM him.  
      User_display_name now has a row with the following values: 
      Colin / 6:45.</p>
    <p>So now, doing a select on user_display_name, this is what I see:</p>
    <div class="tutorialcode"><pre>select * from user_display_name where user_id = 100;
 user_id  | display_name  | effdate
 100      | Colin Rocks!  | 6:15
 100      | Colin         | 6:45</pre></div>
    <h3>user_statistics</h3>
    <p>User statistics keeps a running total of messages sent and received.
      It stores a sender_id, a recipient_id, the total messages, and the date
      of the last
      message sent.  This table is primarily for speed, but not a lot does
      anything with it.</p>
    <h3>message_v</h3>
    <p>The created view is used for all of the message viewing.  It contains
      message_id, message, message_date, the screenames from users
      (sender_sn, sender_service, recipient_sn, recipient_service), and the
      display name at the time the message was sent.  It does
      not contain message_idx, the tsearch field, or any statistical
      information.  Using message_v can allow
      searches based on screenname instead of a (relatively) meaningless
      number.</p>
    <h3>Insertions</h3>
    <p>Both the Adium plugin and the log parsing scripts work by inserting a
      record into message_v.  When an insert is performed, a rule fires.  It
      attempts to insert the screennames into users, and doesn't if that
      screenname already exists.  Then it retrieves the two user_ids and
      inserts a record into message.  It also checks to see if the display
      name has changed, and if it does, inserts a new record into
      user_display_name.  Updates or deletes on message_v silently
      fail, and are best performed by operating directly on the underlying
      tables.</p>
    
    <a name="tsearch.sql"><h2>tsearch.sql</h2></a>
    <p>tsearch indexing requires a special method and index type to do it's
      magic.  It uses a column message_idx, where it stores a list
      of all the words used in the IM in their "base form".  Storing in a base
      form allows it to do stemming.  (Searching for 'kicking' will return
      'kicking', 'kick', 'kicks', etc).  It uses a GiST index to track these
      terms down very quickly, which I REALLY don't understand.  But it does
      work very well.</p>
    <p>tsearch.sql does only four things, but requires that the tsearch module
      be installed to work.</p>
   <ol>
     <li>Adds the column message_idx to messages.</li>
     <li>Sets message_idx to the transformed version for all messages
       currently in the table.</li>
     <li>Creates a GiST index on message_idx.</li>
     <li>Creates a trigger on messages which fires when inserting or updating
       a record.  This trigger converts the text in message to text in
       message_idx.</li>
    </ol>
    <p>This script can take a while to run.  The two steps that take time are
      the update to everything in the table, and creating the index.  Creating
      the index can take 10-15 minutes or more, depending on how much data
      there is in your table.</p>
    
    <a name="parser.pl"><h2>parser.pl</h2></a>
    <div class="important"><code>parser-2.pl</code> does not require DBI and
      DBD::Pg</div>
    <p><code>Parser.pl</code> reads through all 
      of your Adium logs and
      inserts the messages into the database.</p>
    <p>The Perl scripts require a few modules for talking to the database.  It
      requires <code>DBI</code> and <code>DBD::Pg</code>.  DBI is a standard
      database-independant perl module.  You can download it with either CPAN
      or fink. (<a href="http://fink.sourceforge.net"
        class="offsite">http://fink.sourceforge.net</a>)</p>
    <p>To install them via CPAN:</p>
    <div class="tutorialcode"><pre>sudo perl -MCPAN -e 'install DBI'</pre>
    </div>
  <p>If this is your first time running CPAN, it will ask a few questions.
    The defaults are fine.  Or simply tell it you do not want to manually
    configure.</p>
  <p>Now it's time to install DBD::Pg.  It's quite possible that if you have
    trouble this will be the longest step of the process.  Thanks to evands
    for being a guinea pig on this one.</p>
  <p>DBD::Pg has a test where it attempts to connect to a working
    PostgreSQL installation.  If you're installing PostgreSQL 7.4, this will
    currently fail entirely.  (Using DBD::Pg 1.22)</p>
  <p>There are a few environmental variables that need to be set to allow the
    compile process to find the various libraries PostgreSQL installs.
    Set the following:</p>
  <div class="tutorialcode">
    <pre>setenv POSTGRES_INCLUDE=/usr/local/pgsql/include
      setenv POSTGRES_LIB="/usr/local/pgsql/lib -lssl -lcrypto"
setenv DBI_DSN=DBI:Pg:dbname=<i>username</i>
setenv DBI_USER=<i>username</i>
setenv DBI_PASS=<i>password</i></pre>
</div>
<p>If you are running Bash as your shell or using Panther:</p>
<div class="tutorialcode">
  <pre>export POSTGRES_INCLUDE=/usr/local/pgsql/include
export POSTGRES_LIB="/usr/local/pgsql/lib -lssl -lcrypto"
export DBI_DSN=DBI:Pg:dbname=<i>username</i>
export DBI_USER=<i>username</i>
export DBI_PASS=<i>password</i></pre>
</div><br />
<div class="important">Capitalization is very important for the DBI_DSN
      environmental variable!</div>
  <p>If you run it now, you will probably see errors relating to <code>ranlib</code> or
    <code>libpq.a</code>.  Just run the following command preemptively:</p>
  <div class="tutorialcode"><pre>sudo ranlib /usr/local/pgsql/lib/libpq.a</pre>
  </div>
  <p>After running that, install DBD::Pg:</p>
  <div class="tutorialcode"><pre>sudo perl -MCPAN -e 'install DBD::Pg'</pre>
  </div>
  <p>If you're installing PostgreSQL 7.4 and DBD::Pg 1.22, the make test WILL
    fail.  If you are sure you have the environmental variables
    POSTGRES_INCLUDE and POSTGRES_LIB set correctly, you can force an install.</p>
  <div class="tutorialcode"><pre>sudo perl -MCPAN -e shell 'force install DBD::Pg'</pre></div>
  <p>If you want to install via fink, the packages are called "dbi-pm" and
    "dbd-pg-pg" [unstable]</p>.
  <p><code>parser.pl</code> will look in <code>~/Library/Application
      Support/Adium/Users</code> for all of the Adium 1.6 logs.  When it's
    there, it will iterate over every folder [users who logged in] and
    everyone they talked to.</p>
  <p><code>parser-2.pl</code> looks in <code>~/Library/Application
      Support/Adium 2.0/</code>.
    As it's iterating over conversations, it gleans the service
    used from the name of the folder (AIM.fetchgreebledonx).</p>
  <p>Both scripts insert messages into message_v.  The parser scripts will
    capture status changing incidents (idle, away, etc), but the SQL Logger
    plugin will not.</p>
  <p>Both scripts will rename the log files they insert, so if there is a
    problem the script can be run multiple times.  Adium has no problem
    reading the renamed log files.</p>
  <p>It may not pass on the first time through.  If you have malformed logs,
    or a few weird messages, it will die.  Simple correct the log, or move it
    out of the way.  It particularly has trouble with copy and pasted
    logs and IMs.</p>
  <p><code>restore.pl</code> simply undoes the 
    renaming, so they go back to the standard Adium filenames.  Requires no
    additional modules.</p>
  <h4>Troubleshooting</h4>
  I have run into the following problems with the parsing scripts:
    <ul>
      <li>About half a dozen of my logs were encoded incorrectly.  I have no
        idea what caused this, or if it's a common problem.  My solution was
        to move the logs out and try again.</li>
      <li>If the database is Unicode-encoded, it will be very picky about
        inserting characters it doesn't know into it.  Since Adium doesn't log
        as Unicode, this could cause some problems.</li>
      <li>If you are getting undefined errors like this:
        <pre>dyld: perl Undefined symbols:
          _BIO_free
          _BIO_new_mem_buf
          _DH_check
          _DH_generate_parameters
          _DH_size
          _ERR_get_error
          _ERR_reason_error_string
          _EVP_PKEY_free
          _PEM_read_DHparams
          _PEM_read_PrivateKey
          _PEM_read_X509
          _PEM_read_bio_DHparams
          _SSL_CTX_ctrl
          _SSL_CTX_free
          _SSL_CTX_load_verify_locations
          _SSL_CTX_new
          _SSL_CTX_set_tmp_dh_callback
          _SSL_CTX_set_verify
          _SSL_CTX_set_verify_depth
          _SSL_connect
          _SSL_free
          _SSL_get_error
          _SSL_get_ex_data
          _SSL_get_peer_certificate
          _SSL_library_init
          _SSL_load_error_strings
          _SSL_new
          _SSL_pending
          _SSL_read
          _SSL_set_ex_data
          _SSL_set_fd
          _SSL_shutdown
          _SSL_write
          _TLSv1_method
          _X509_NAME_get_text_by_NID
          _X509_NAME_oneline
          _X509_check_private_key
          _X509_free
          _X509_get_subject_name</pre>
        This is caused by not including <b>-lssl -lcrypto</b> in the library path as you
        compiled DBD::Pg.</li>
      <li>If you get an error like this:
        <pre>dyld: perl Undefined symbols:
          _is_utf8_string
          Trace/BPT trap</pre>You may need to upgrade Perl, unfortunately.
        There are directions for installing Perl 5.8.0 at <a
          href="http://developer.apple.com/internet/macosx/perl.html"
          class="offsite">http://developer.apple.com/internet/macosx/perl.html</a>.</li>
    </ul>
 </body>
</page>
